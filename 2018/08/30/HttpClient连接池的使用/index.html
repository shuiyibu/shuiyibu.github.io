<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="HttpClient,PoolingHttpClientConnectionManager,">





  <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">






<meta name="description" content="1. HttpClient 简介HttpClient 是Apache的一个子项目，是可以提供支持HTTP协议的Java客户端编程工具包。在实际项目的使用过程中，经常都是多线程访问，因此可能存在多个线程都需要调用HttpClient对象的情况，这类似于数据库连接，所以我们需要对连接进行池化管理，以便于提高性能。HttpClient从4.2开始抛弃了先前的SingleClientConnManage">
<meta name="keywords" content="HttpClient,PoolingHttpClientConnectionManager">
<meta property="og:type" content="article">
<meta property="og:title" content="HttpClient连接池的使用">
<meta property="og:url" content="http://yoursite.com/2018/08/30/HttpClient连接池的使用/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="1. HttpClient 简介HttpClient 是Apache的一个子项目，是可以提供支持HTTP协议的Java客户端编程工具包。在实际项目的使用过程中，经常都是多线程访问，因此可能存在多个线程都需要调用HttpClient对象的情况，这类似于数据库连接，所以我们需要对连接进行池化管理，以便于提高性能。HttpClient从4.2开始抛弃了先前的SingleClientConnManage">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-08-30T08:57:08.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="HttpClient连接池的使用">
<meta name="twitter:description" content="1. HttpClient 简介HttpClient 是Apache的一个子项目，是可以提供支持HTTP协议的Java客户端编程工具包。在实际项目的使用过程中，经常都是多线程访问，因此可能存在多个线程都需要调用HttpClient对象的情况，这类似于数据库连接，所以我们需要对连接进行池化管理，以便于提高性能。HttpClient从4.2开始抛弃了先前的SingleClientConnManage">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/08/30/HttpClient连接池的使用/">





  <title>HttpClient连接池的使用 | Hexo</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?4d5b541690a836307558f5f13157a238";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/30/HttpClient连接池的使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dylan Lang">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">HttpClient连接池的使用</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-30T16:52:46+08:00">
                2018-08-30
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HttpClient/" itemprop="url" rel="index">
                    <span itemprop="name">HttpClient</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/08/30/HttpClient连接池的使用/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/08/30/HttpClient连接池的使用/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <a id="more"></a>
<h2 id="1-HttpClient-简介"><a href="#1-HttpClient-简介" class="headerlink" title="1. HttpClient 简介"></a>1. HttpClient 简介</h2><p><a href="https://hc.apache.org/httpcomponents-client-ga/" target="_blank" rel="noopener">HttpClient</a> 是Apache的一个子项目，是可以提供支持HTTP协议的Java客户端编程工具包。在实际项目的使用过程中，经常都是多线程访问，因此可能存在多个线程都需要调用HttpClient对象的情况，这类似于数据库连接，所以我们需要对连接进行池化管理，以便于提高性能。<br>HttpClient从4.2开始抛弃了先前的<code>SingleClientConnManager</code>和<code>ThreadSafeConnManger</code>，取而代之的是<code>BasicClientConnectionManager</code>和<code>PoolingClientConnectionManager</code>，本文使用的是HttpClient 4.5 版本。</p>
<h2 id="2-编码和测试"><a href="#2-编码和测试" class="headerlink" title="2. 编码和测试"></a>2. 编码和测试</h2><h3 id="2-1-创建PoolingHttpClientConnectionManager"><a href="#2-1-创建PoolingHttpClientConnectionManager" class="headerlink" title="2.1 创建PoolingHttpClientConnectionManager"></a>2.1 创建PoolingHttpClientConnectionManager</h3><p>PoolingHttpClientConnectionManager实现了HttpClientConnectionManager接口，顾名思义，它就是用来对连接进行池化管理的，首先创建一个对象，并在类加载时初始化它：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">public class HttpClientTest &#123;</span><br><span class="line"></span><br><span class="line">    // 池化管理</span><br><span class="line">    private static PoolingHttpClientConnectionManager poolConnManager = null;</span><br><span class="line"></span><br><span class="line">    private static CloseableHttpClient httpClient;</span><br><span class="line">    //请求器的配置</span><br><span class="line">    private static RequestConfig requestConfig;</span><br><span class="line"></span><br><span class="line">    static &#123;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            System.out.println(&quot;初始化HttpClientTest~~~开始&quot;);</span><br><span class="line">            SSLContextBuilder builder = new SSLContextBuilder();</span><br><span class="line">            builder.loadTrustMaterial(null, new TrustSelfSignedStrategy());</span><br><span class="line">            SSLConnectionSocketFactory sslsf = new SSLConnectionSocketFactory(</span><br><span class="line">                    builder.build());</span><br><span class="line">            // 配置同时支持 HTTP 和 HTPPS</span><br><span class="line">            Registry&lt;ConnectionSocketFactory&gt; socketFactoryRegistry = RegistryBuilder.&lt;ConnectionSocketFactory&gt; create().register(</span><br><span class="line">                    &quot;http&quot;, PlainConnectionSocketFactory.getSocketFactory()).register(</span><br><span class="line">                    &quot;https&quot;, sslsf).build();</span><br><span class="line">            // 初始化连接管理器</span><br><span class="line">            poolConnManager = new PoolingHttpClientConnectionManager(</span><br><span class="line">                    socketFactoryRegistry);</span><br><span class="line">            // 将最大连接数增加到200，实际项目最好从配置文件中读取这个值</span><br><span class="line">            poolConnManager.setMaxTotal(200);</span><br><span class="line">            // 设置最大路由</span><br><span class="line">            poolConnManager.setDefaultMaxPerRoute(2);</span><br><span class="line">            // 根据默认超时限制初始化requestConfig</span><br><span class="line">            int socketTimeout = 10000;</span><br><span class="line">            int connectTimeout = 10000;</span><br><span class="line">            int connectionRequestTimeout = 10000;</span><br><span class="line">            requestConfig = RequestConfig.custom().setConnectionRequestTimeout(</span><br><span class="line">                    connectionRequestTimeout).setSocketTimeout(socketTimeout).setConnectTimeout(</span><br><span class="line">                    connectTimeout).build();</span><br><span class="line"></span><br><span class="line">            // 初始化httpClient</span><br><span class="line">            httpClient = getConnection();</span><br><span class="line"></span><br><span class="line">            System.out.println(&quot;初始化HttpClientTest~~~结束&quot;);</span><br><span class="line">        &#125; catch (NoSuchAlgorithmException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (KeyStoreException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (KeyManagementException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码中我们只保存了一个全局的HttpClient对象，在多线程情况下，每个线程都会用这个对象去发HTTP请求，乍一看似乎有线程安全问题，但是查看了<a href="https://hc.apache.org/httpcomponents-client-4.5.x/tutorial/html/connmgmt.html#d5e405" target="_blank" rel="noopener">官方文档</a>并做实验验证后，发现这是没有问题的：</p>
<blockquote>
</blockquote>
<p>When equipped with a pooling connection manager such as PoolingClientConnectionManager, HttpClient can be used to execute multiple requests simultaneously using multiple threads of execution.</p>
<blockquote>
</blockquote>
<p>The PoolingClientConnectionManager will allocate connections based on its configuration. If all connections for a given route have already been leased, a request for a connection will block until a connection is released back to the pool. One can ensure the connection manager does not block indefinitely in the connection request operation by setting ‘http.conn-manager.timeout’ to a positive value. If the connection request cannot be serviced within the given time period ConnectionPoolTimeoutException will be thrown.</p>
<blockquote>
</blockquote>
<p>While HttpClient instances are thread safe and can be shared between multiple threads of execution, it is highly recommended that each thread maintains its own dedicated instance of HttpContext .</p>
<blockquote>
</blockquote>
<p><code>getConnection()</code> 方法是根据我们创建好的PoolingHttpClientConnectionManager对象去创建一个线程安全的HttpClient对象，具体代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public static CloseableHttpClient getConnection() &#123;</span><br><span class="line">    CloseableHttpClient httpClient = HttpClients.custom()</span><br><span class="line">            // 设置连接池管理</span><br><span class="line">            .setConnectionManager(poolConnManager)</span><br><span class="line">            // 设置请求配置</span><br><span class="line">            .setDefaultRequestConfig(requestConfig)</span><br><span class="line">            // 设置重试次数</span><br><span class="line">            .setRetryHandler(new DefaultHttpRequestRetryHandler(0, false))</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">    if (poolConnManager != null &amp;&amp; poolConnManager.getTotalStats() != null)</span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(&quot;now client pool &quot;</span><br><span class="line">                + poolConnManager.getTotalStats().toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return httpClient;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到我们用一些HttpClients的静态方法配置好了ConnectionManager和RequestConfig，最后build了一个HttpClient的对象，这个就是一个全局带池化管理的对象，假如其中的某个线程调用了HttpClient的<code>close()</code> 方法，那么接下来的线程就别想再用这个对象去发起HTTP请求了。</p>
<p>创建好了对象，我们再提供一个发起GET请求的方法，其它线程可以直接调用这个方法去发起一个GET请求，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public static void httpGet(String url) &#123;</span><br><span class="line">    HttpGet httpGet = new HttpGet(url);</span><br><span class="line">    CloseableHttpResponse response = null;</span><br><span class="line">    try &#123;</span><br><span class="line">        response = httpClient.execute(httpGet);</span><br><span class="line">        HttpEntity entity = response.getEntity();</span><br><span class="line">        String result = EntityUtils.toString(entity, &quot;utf-8&quot;);</span><br><span class="line">        EntityUtils.consume(entity);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            if (response != null)</span><br><span class="line">                response.close();</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再创建一个用于测试的线程类，具体代码和上面的<code>httpGet()</code> 方法类似，只不过增加了一些循环和打印的语句等：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">static class GetThread extends Thread &#123;</span><br><span class="line">    private CloseableHttpClient httpClient;</span><br><span class="line">    private String url;</span><br><span class="line"></span><br><span class="line">    public GetThread(CloseableHttpClient client, String url) &#123;</span><br><span class="line">        httpClient = client;</span><br><span class="line">        this.url = url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void run() &#123;</span><br><span class="line">        for(int i = 0; i &lt; 3; i++) &#123;</span><br><span class="line">            HttpGet httpGet = new HttpGet(url);</span><br><span class="line">            CloseableHttpResponse response = null;</span><br><span class="line">            try &#123;</span><br><span class="line">                response = httpClient.execute(httpGet);</span><br><span class="line">                HttpEntity entity = response.getEntity();</span><br><span class="line">                String result = EntityUtils.toString(entity, &quot;utf-8&quot;);</span><br><span class="line">                // EntityUtils.consume(entity);</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + &quot; Finished&quot;);</span><br><span class="line">            &#125; catch (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    if (response != null) &#123;</span><br><span class="line">                        response.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (httpGet != null) &#123;</span><br><span class="line">                        httpGet.releaseConnection();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在，只要在main函数中添加测试代码就可以完成测试了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">    HttpClientTest.httpGet(&quot;https://kmg343.gitbooks.io/httpcl-ient4-4-no2/content/233_lian_jie_chi_guan_li_qi.html&quot;);</span><br><span class="line">    String[] urisToGet = &#123;</span><br><span class="line">            &quot;https://kmg343.gitbooks.io/httpcl-ient4-4-no2/content/24_duo_xian_cheng_zhi_xing_qing_qiu.html&quot;,</span><br><span class="line">            &quot;https://kmg343.gitbooks.io/httpcl-ient4-4-no2/content/24_duo_xian_cheng_zhi_xing_qing_qiu.html&quot;,</span><br><span class="line">            &quot;https://kmg343.gitbooks.io/httpcl-ient4-4-no2/content/24_duo_xian_cheng_zhi_xing_qing_qiu.html&quot;,</span><br><span class="line">            &quot;https://kmg343.gitbooks.io/httpcl-ient4-4-no2/content/24_duo_xian_cheng_zhi_xing_qing_qiu.html&quot;,</span><br><span class="line">            &quot;https://kmg343.gitbooks.io/httpcl-ient4-4-no2/content/24_duo_xian_cheng_zhi_xing_qing_qiu.html&quot;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    GetThread[] threads = new GetThread[urisToGet.length];</span><br><span class="line">    for (int i = 0; i &lt; threads.length; i++) &#123;</span><br><span class="line">        threads[i] = new GetThread(httpClient, urisToGet[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for (Thread tmp : threads) &#123;</span><br><span class="line">        tmp.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里先试着用了一次静态的<code>httpGet()</code> 方法去发送GET请求，然后启动了5个线程去发送请求，假如我们把static初始化块中的<code>poolConnManager.setMaxTotal(200);</code> 改为 <code>poolConnManager.setMaxTotal(2);</code> 我们可以在控制台看到如下的输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">15:59:40,628 DEBUG PoolingHttpClientConnectionManager:314 - Connection [id: 0][route: &#123;s&#125;-&gt;https://kmg343.gitbooks.io:443] can be kept alive indefinitely</span><br><span class="line">15:59:40,629 DEBUG PoolingHttpClientConnectionManager:320 - Connection released: [id: 0][route: &#123;s&#125;-&gt;https://kmg343.gitbooks.io:443][total kept alive: 1; route allocated: 1 of 2; total allocated: 1 of 2]</span><br><span class="line">......</span><br><span class="line">15:59:47,401 DEBUG PoolingHttpClientConnectionManager:314 - Connection [id: 0][route: &#123;s&#125;-&gt;https://kmg343.gitbooks.io:443] can be kept alive indefinitely</span><br><span class="line">15:59:47,401 DEBUG PoolingHttpClientConnectionManager:320 - Connection released: [id: 0][route: &#123;s&#125;-&gt;https://kmg343.gitbooks.io:443][total kept alive: 1; route allocated: 2 of 2; total allocated: 2 of 2]</span><br><span class="line">Thread-4 Finished</span><br></pre></td></tr></table></figure>
<p>而假如仍然是分配200个连接的话，total allocated:就会显示为2 of 200，可以看到连接池生效了，多线程并发调用没有问题。假如我们在测试线程的for循环中添加了<code>httpClient.close();</code> 语句，则可以看到控制台在发起了一些连接后抛出异常，提示连接池已经关闭。请记得每个请求返回处理后，调用EntityUtils.toString或者EntityUtils.consume()关闭流，以下是官网的解释：</p>
<blockquote>
</blockquote>
<p>The difference between closing the content stream and closing the response is that the former will attempt to keep the underlying connection alive by consuming the entity content while the latter immediately shuts down and discards the connection.<br>When working with streaming entities, one can use the <code>EntityUtils#consume(HttpEntity)</code>method to ensure that the entity content has been fully consumed and the underlying stream has been closed. There can be situations, however, when only a small portion of the entire response content needs to be retrieved and the performance penalty for consuming the remaining content and making the connection reusable is too high, in which case one can terminate the content stream by closing the response.</p>
<blockquote>
</blockquote>
<p>由于我们在实际应用中，访问的链接可能都是事先在代码中定义好的，所以我们没必要关闭连接，只需要把流关闭或消费完，让连接keep-alive，这样下一个线程重用这个连接时就可以省去TCP的三次握手过程了。</p>
<h2 id="3-一些总结"><a href="#3-一些总结" class="headerlink" title="3. 一些总结"></a>3. 一些总结</h2><h3 id="3-1-每个路由-route-最大连接数"><a href="#3-1-每个路由-route-最大连接数" class="headerlink" title="3.1 每个路由(route)最大连接数"></a>3.1 每个路由(route)最大连接数</h3><p>上面我们有一行这样的代码：<code>poolConnManager.setDefaultMaxPerRoute(2);</code> 用于设置最大路由，这里route的概念可以理解为 <strong>运行环境机器</strong> 到 <strong>目标机器</strong> 的一条线路。举例来说，我们使用HttpClient的实现来分别请求 <a href="http://www.baidu.com" target="_blank" rel="noopener">www.baidu.com</a> 的资源和 <a href="http://www.bing.com" target="_blank" rel="noopener">www.bing.com</a> 的资源那么他就会产生两个route。以下是网上对设置这个参数的一些解释：</p>
<blockquote>
</blockquote>
<p>这里为什么要特别提到route最大连接数这个参数呢，因为这个参数的默认值为2，如果不设置这个参数，值默认情况下对于同一个目标机器的最大并发连接只有2个！这意味着如果你正在执行一个针对某一台目标机器的抓取任务的时候，哪怕你设置连接池的最大连接数为200，但是实际上还是只有2个连接在工作，其他剩余的198个连接都在等待，都是为别的目标机器服务的。</p>
<blockquote>
</blockquote>
<h3 id="3-2-BasicClientConnectionManager"><a href="#3-2-BasicClientConnectionManager" class="headerlink" title="3.2 BasicClientConnectionManager"></a>3.2 BasicClientConnectionManager</h3><p>BasicClientConnectionManager内部只维护一个活动的connection，尽管这个类是线程安全的，但是最好在一个单独的线程中重复使用它。如果在同一个BasicClientConnectionManager对象中，多次执行http请求，后继请求与先前请求是同一个route，那么BasicClientConnectionManager会使用同一个连接完成后续请求，否则，BasicClientConnectionManager会将先前的connection关闭，然后为后续请求创建一个新的连接。换句话说，BasicClientConnectionManager会尽力复用先前的连接（注意：创建连接和销毁连接都是不小的开销）</p>
<h3 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h3><p><a href="https://hc.apache.org/httpcomponents-client-4.5.x/tutorial/html/index.html" target="_blank" rel="noopener">1. HttpClient Tutorial</a><br><a href="https://github.com/taobinxian/Blogs/wiki/HttpClient%E4%BD%BF%E7%94%A8" target="_blank" rel="noopener">2. HttpClient使用</a><br><a href="https://kmg343.gitbooks.io/httpcl-ient4-4-no2/content/233_lian_jie_chi_guan_li_qi.html" target="_blank" rel="noopener">3. HttpClient4.4中文教程</a><br><a href="http://blog.csdn.net/wangpeng047/article/details/19624529" target="_blank" rel="noopener">4. HttpClient使用详解</a></p>
<p><a href="https://my.oschina.net/JoeyXieIsCool/blog/734730" target="_blank" rel="noopener">https://my.oschina.net/JoeyXieIsCool/blog/734730</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/HttpClient/" rel="tag"># HttpClient</a>
          
            <a href="/tags/PoolingHttpClientConnectionManager/" rel="tag"># PoolingHttpClientConnectionManager</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/08/30/Java/SimpleDateFormat-的线程安全问题与-ThreadLocal/" rel="next" title="SimpleDateFormat 的线程安全问题与 ThreadLocal">
                <i class="fa fa-chevron-left"></i> SimpleDateFormat 的线程安全问题与 ThreadLocal
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/08/30/RestTemplate/" rel="prev" title="RestTemplate">
                RestTemplate <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div class="ds-thread" data-thread-key="2018/08/30/HttpClient连接池的使用/" data-title="HttpClient连接池的使用" data-url="http://yoursite.com/2018/08/30/HttpClient连接池的使用/">
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpeg" alt="Dylan Lang">
            
              <p class="site-author-name" itemprop="name">Dylan Lang</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">513</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">32</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">120</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/yourname" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:yourname@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-HttpClient-简介"><span class="nav-number">1.</span> <span class="nav-text">1. HttpClient 简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-编码和测试"><span class="nav-number">2.</span> <span class="nav-text">2. 编码和测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-创建PoolingHttpClientConnectionManager"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 创建PoolingHttpClientConnectionManager</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-一些总结"><span class="nav-number">3.</span> <span class="nav-text">3. 一些总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-每个路由-route-最大连接数"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 每个路由(route)最大连接数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-BasicClientConnectionManager"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 BasicClientConnectionManager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考文献"><span class="nav-number">3.3.</span> <span class="nav-text">参考文献</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Dylan Lang</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"your-duoshuo-shortname"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  


















  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
